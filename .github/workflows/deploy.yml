name: Deploy Fabric Items

on:
  push:
    branches:
      - master
      - 'release/*'
    paths:
      - 'fabric_items/**'
  pull_request:
    branches:
      - master
    paths:
      - 'fabric_items/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TARGET_ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .cicd/requirements.txt

      - name: Azure CLI login (device code)
        run: |
          az login --use-device-code

      ## get accesss token
      - name: Get Fabric access token
        id: fabric_token
        run: |
          TOKEN=$(az account get-access-token --resource https://api.fabric.microsoft.com --query accessToken -o tsv)
          echo "FABRIC_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Run authentication and deployment script
        run: |
          echo "Target Environment: $TARGET_ENVIRONMENT"
          python .cicd/authenticate_spn.py $TARGET_ENVIRONMENT

      - name: Set Variable Library active value set
        run: |
          python .cicd/set_variable_group.py "$TARGET_ENVIRONMENT" "$FABRIC_TOKEN"


      - name: Upload error log
        if: always()
        uses: actions/upload-artifact@v4

        with:
          name: errorlog
          path: fabric_cicd.error.log
