name: Deploy Fabric Items (Multi-Stage)

on:
  push:
    branches:
      - master
    paths:
      - 'fabric_items/**'
  workflow_dispatch:

jobs:
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    environment: dev   # "Environments"

    env:
      TARGET_ENVIRONMENT: dev

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .cicd/requirements.txt

      - name: Azure CLI login (device code)
        run: az login --use-device-code

      - name: Get Fabric access token
        id: fabric_token
        run: |
          TOKEN=$(az account get-access-token --resource https://api.fabric.microsoft.com --query accessToken -o tsv)
          echo "FABRIC_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Deploy to Dev (Variable Group etc.)
        run: |
          echo "Deploying to DEV..."
          python .cicd/set_variable_group.py "$TARGET_ENVIRONMENT" "$FABRIC_TOKEN"

      - name: Create Deployment Pipeline (in dev)
        run: |
          echo "Creating deployment pipeline in DEV environment (hardcoded)..."
          python .cicd/deployment_pipeline.py "$FABRIC_TOKEN"

  deploy-test:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'test'
    name: Deploy to Test
    runs-on: ubuntu-latest
    needs: deploy-dev   # run only after dev succeeds
    environment: test   # this requires approval

    env:
      TARGET_ENVIRONMENT: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .cicd/requirements.txt

      - name: Azure CLI login (device code)
        run: az login --use-device-code

      - name: Get Fabric access token
        id: fabric_token
        run: |
          TOKEN=$(az account get-access-token --resource https://api.fabric.microsoft.com --query accessToken -o tsv)
          echo "FABRIC_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Deploy to Test (Variable Group etc.)
        run: |
          echo "Deploying to TEST..."
          python .cicd/set_variable_group.py "$TARGET_ENVIRONMENT" "$FABRIC_TOKEN"
